# æ‰¿è¯º Promise

Promise ä»£è¡¨ä¸€ä¸ª**å¼‚æ­¥**æ“ä½œçš„æœ€ç»ˆå®Œæˆ(æˆ–å¤±è´¥)åŠå…¶ç»“æœå€¼ã€‚ 

Promise æ˜¯ `ES6` çš„ç‰¹æ€§ï¼Œå¦‚æœéœ€è¦å…¼å®¹æ²¡æœ‰åŸç”Ÿ Promise çš„æµè§ˆå™¨ï¼Œåªéœ€å¼•å…¥ä¸€ä¸ª [Promise åº“](https://github.com/stefanpenner/es6-promise) å°±å¥½äº†ã€‚

Promise æœ‰ä¸‰ç§å¯èƒ½çš„çŠ¶æ€ 

| çŠ¶æ€       | è¯´æ˜                |
|-----------|---------------------|
| `pending` | æœªå®š `åˆå§‹å€¼`         | 
|`resolved` | å…‘ç° `resolve(value)`|
| `rejected`| æ‹’ç» `reject(error)` |

## è®¸ä¸‹æ‰¿è¯º new Promise(executor)
è®¸ä¸‹ä¸€ä¸ªæ‰¿è¯º
```javascript
> let promise = new Promise(function(resolve, reject) {})
â†’ undefined

> promise
â†’ Promise {[[PromiseStatus]]: "pending", [[PromiseValue]]: undefined}
```

è®¸ä¸‹ä¸€ä¸ªæ‰¿è¯ºå¹¶é©¬ä¸Šå…‘ç° `resolve('æˆ˜ç‹¼2')`
```javascript
> let ä¸€èµ·çœ‹ç”µå½± = new Promise(function(resolve, reject) { resolve('æˆ˜ç‹¼2'); })
â†’ undefined

> ä¸€èµ·çœ‹ç”µå½±
â†’ Promise {[[PromiseStatus]]: "resolved", [[PromiseValue]]: "æˆ˜ç‹¼2"}
```

è®¸ä¸‹ä¸€ä¸ªæ‰¿è¯ºï¼Œæƒ³äº†ä¸€ç§’é’Ÿï¼Œæ‹’ç»ã€‚`reject('ä»Šæ™šè¦ä¸Šè¯¾')`
```javascript
> let ä¸€èµ·æ‰“ç¯®çƒ = new Promise(function(resolve, reject) { setTimeout(() => reject('ä»Šæ™šè¦ä¸Šè¯¾'), 1000); })
â†’ undefined

Ã— Uncaught (in promise) ä»Šæ™šè¦ä¸Šè¯¾

> ä¸€èµ·æ‰“ç¯®çƒ
â†’ Promise {[[PromiseStatus]]: "rejected", [[PromiseValue]]: "ä»Šæ™šè¦ä¸Šè¯¾"}
```
ğŸ’¡ `resolve` å’Œ `reject` æ˜¯ Promise æä¾›çš„å‡½æ•°ã€‚

ğŸ’¡ `new Promise(executor)` ä¸­çš„ `executor` å‡½æ•°åœ¨ Promise åˆå§‹åŒ–çš„æ—¶å€™ç«‹å³æ‰§è¡Œã€‚

## ç„¶åæ€æ · then()
Promise çš„å€¼æ— æ³•ç›´æ¥è·å–ï¼Œéœ€è¦è°ƒç”¨ `then()` æ–¹æ³•ã€‚
```javascript
let trip = new Promise((resolve, reject) => {
  setTimeout(() => resolve('é¦™æ¸¯ ğŸ‡­ğŸ‡°'), 1000);
});

let hk = trip.then(function(place) {
  return place;
});

let au = hk.then(place => {
    console.log(place);                 // é¦™æ¸¯ ğŸ‡­ğŸ‡°
    return `${place} -> æ³°å›½ ğŸ‡¹ğŸ‡­`;        
  })
  .then(places => {
    console.log(places);                // é¦™æ¸¯ ğŸ‡­ğŸ‡° -> æ³°å›½ ğŸ‡¹ğŸ‡­
    return `${places} -> æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬`;
  })
  .then(places => {
    console.log(places);                // é¦™æ¸¯ ğŸ‡­ğŸ‡° -> æ³°å›½ ğŸ‡¹ğŸ‡­ -> æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬
    return new Promise((resolve, reject) => {
      setTimeout(() => resolve(`${places} -> æ–°è¥¿å…° ğŸ‡³ğŸ‡¿`), 3000);
    });
  })
  .then(places => {
    console.log(places);                // é¦™æ¸¯ ğŸ‡­ğŸ‡° -> æ³°å›½ ğŸ‡¹ğŸ‡­ -> æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬ -> æ–°è¥¿å…° ğŸ‡³ğŸ‡¿
    return new Promise((resolve, reject) => {
      setTimeout(() => resolve(`${places} -> æ¾³æ´² ğŸ‡¦ğŸ‡º`), 1500);
    });
  })
  .then(places => {
    console.log(places);                // é¦™æ¸¯ ğŸ‡­ğŸ‡° -> æ³°å›½ ğŸ‡¹ğŸ‡­ -> æ–°åŠ å¡ ğŸ‡¸ğŸ‡¬ -> æ–°è¥¿å…° ğŸ‡³ğŸ‡¿ -> æ¾³æ´² ğŸ‡¦ğŸ‡º
    return places;
  });
```

## å¦‚æœä¸è¡Œ catch()
```javascript
let play = new Promise(function(resolve, reject) { 
 Â setTimeout(() => reject(new Error('ä¸å¥½æ„æ€ğŸ˜…ï¼Œä»Šæ™šè¦ä¸Šè¯¾')), 1000); Â  Â  // é€šå¸¸ç”¨ Error è¡¨ç¤ºæ‹’ç»åŸå› 
});

play.catch(function(error) {
 Â console.log(error.message);
});
```
äº‹å®ä¸Šï¼Œ`catch()` æ˜¯ `then(null, onReject)` çš„ç¼©å†™ã€‚
```javascript
let home = au.then(() => {
 Â return Promise.reject(new Error('é’±ğŸ’°èŠ±ğŸŒºå…‰äº†ï¼Œè‚¥å®¶ï¼'));
}).then(null, error => {
  console.log(error.message);
 Â return 'å®¶ğŸ¡';
});
```

## Fetch
`fetch()` å³ AJAX + Promiseï¼Œè¯¦è§ `JavaScript/AJAX/03. Fetch.md`ã€‚

### XMLHttpRequest + Promise
```javascript
function getJSON(url) {
  return new Promise((resolve, reject) => {
    let xhr = new XMLHttpRequest();
    xhr.responseType = 'json';
    xhr.open('GET', url);
    xhr.onload = function() { resolve(this.response) };
    xhr.onerror = reject;
    xhr.send();
  });
}

getJSON('https://fe13.now.sh/api/posts').then(console.log)
```

## éšå¼ try...catch
`new Promise(executor)` çš„ `executor` è¢«ä¸€ä¸ªæ— å½¢çš„ `try...catch` åŒ…å›´ï¼Œä¸€æ—¦å‡ºé”™ï¼ŒPromise çš„çŠ¶æ€å˜æˆ `rejected`ã€‚

```javascript
new Promise(() => {
 Â throw new Error('è¦è¿Ÿåˆ°å•¦å•¦å•¦å•¦~\(â‰§â–½â‰¦)/~â°â°â°â°â°');
}).catch(error => {
  console.log(error.message);
 Â return 'ä»Šå¤©æ˜ŸæœŸå¤©';
}).then(day => {
 Â console.log(day, 'ç»§ç»­ç¡è§‰ğŸ˜´');
})
```

## Promise API
`Promise.resolve()` æ–¹æ³•è¿”å›ä¸€ä¸ªå·²ç»å…‘ç°çš„æ‰¿è¯ºğŸ˜ã€‚
```javascript
> Promise.resolve('å»ç°åœºçœ‹ NBA æ€»å†³èµ›');
â†’ Promise {[[PromiseStatus]]: "resolved", [[PromiseValue]]: "å»ç°åœºçœ‹ NBA æ€»å†³èµ›"}
```

`Promise.reject()` æ–¹æ³•è¿”å›ä¸€ä¸ªå·²ç»è¢«æ‹’ç»å…‘ç°çš„æ‰¿è¯ºğŸ˜…ã€‚
```javascript
Promise.reject(new Error('æ€ä¹ˆäº† ä½ ç´¯äº† è¯´å¥½çš„å¹¸ç¦å‘¢'))
 Â .catch(error => {
    console.log(error.message);
 Â  Â return 'æˆ‘æ‡‚äº† ä¸è¯´äº† çˆ±æ·¡äº† æ¢¦è¿œäº†'
  })
  .then(byebye => {
    console.log(byebye);
  })
```
 
`Promise.all()` æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise åªåœ¨ä¸€ç³»åˆ—æŒ‡å®šçš„ Promise è¢« `resolve` åæ‰ä¼šè¢« `resolve`ã€‚
```javascript
Promise.all([
  fetch('https://raw.githubusercontent.com/fe13/fe/master/JavaScript/AJAX/json/jay.json'),
  fetch('https://raw.githubusercontent.com/fe13/fe/master/JavaScript/AJAX/json/jay.albums.json')
])
  .then(responses => Promise.all(responses.map(response => response.json())))
 Â .then(jsons => {
 Â  Â let [jay, albums] = jsons; Â  Â  // ç­‰ä»·äº let jay = jsons[0], albums = jsons[1];
 Â  Â jay.albums = albums;
 Â  Â console.log(jay);
 Â  Â return jay;
  })
  .catch(error => {
 Â  Â console.log(error.message); Â   // å…¶ä¸­ä¸€ä¸ªè¯·æ±‚å‡ºç°é”™è¯¯æ•´ä¸ª Promise å°±ä¼šè¢« reject
 Â })
```
ğŸ’¡ `response.json()` è¿”å›ä¸€ä¸ª Promiseã€‚

`Promise.race()` æ–¹æ³•ä¸ `Promise.all()` ç±»ä¼¼ï¼Œä½†å®ƒå…³æ³¨çš„æ˜¯ç¬¬ä¸€ä¸ªè¢« `resolve` æˆ– `reject` çš„ Promiseã€‚

```javascript
Promise.race([
 Â new Promise((resolve, reject) => setTimeout(() => resolve('ğŸš’'), 9000)),
 Â new Promise((resolve, reject) => setTimeout(() => resolve('ğŸš€'), 1000)),
  new Promise((resolve, reject) => setTimeout(() => reject(new Error('ğŸ’¥')), 3000))
]).then(console.log) Â   // ğŸš€
```

## async/await
`async` `await` è®© Promise ç”¨èµ·æ¥æ›´èˆ’æœï¼Œè€Œä¸”å¾ˆå®¹æ˜“ç†è§£å’Œä½¿ç”¨ã€‚

### async
```javascript
async function animal() {
 Â return 'ğŸ¶';
}
```
`async` è¡¨æ˜è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª Promiseï¼Œè‹¥è¿”å›çš„æ˜¯é Promise çš„å€¼ï¼Œåˆ™è‡ªåŠ¨è½¬æˆ `return Promise.resolve(val)`ã€‚

```javascript
> animal()
â†’ Promise {[[PromiseStatus]]: "resolved", [[PromiseValue]]: "ğŸ¶"}
```
### await
`await` ç­‰å¾…ä¸€ä¸ª Promise è¢« `resolve` å¹¶è¿”å›å®ƒçš„å€¼ã€‚âš ï¸ `await` åªèƒ½åœ¨ `async function` å†…ä½¿ç”¨ã€‚
```javascript
(async function() {
  let url = 'https://raw.githubusercontent.com/fe13/fe/master/JavaScript/AJAX/json/jay.json';
  let res = await fetch(url);
  let jay = await res.json();
  console.log(jay);
})();
```
`async` `await` ä¹Ÿå¯ä»¥åœ¨æ–¹æ³•ä¸Šä½¿ç”¨ã€‚
```javascript
class Cat {
  async sleep(sec) {
 Â  Â console.log('ğŸ˜´ ğŸ’¤ğŸ’¤ğŸ’¤');
 Â  Â await new Promise(resolve => setTimeout(() => resolve(), sec * 1000));
    console.log('ğŸ˜ ğŸŒˆğŸŒˆğŸŒˆ');
  }
}

let tom = new Cat();
tom.sleep(5);
```
`await` è¿˜å¯ä»¥ç»“åˆ `Promise.all()` ä½¿ç”¨ã€‚
```javascript
(async function() {
  let responses = await Promise.all([
    fetch('https://raw.githubusercontent.com/fe13/fe/master/JavaScript/AJAX/json/jay.json'),
    fetch('https://raw.githubusercontent.com/fe13/fe/master/JavaScript/AJAX/json/jay.albums.json')
  ]);
  let [jay, albums] = await Promise.all(responses.map(response => response.json()));
  jay.albums = albums
  console.log(jay);
})();
```

### é”™è¯¯å¤„ç†
ä½¿ç”¨ `async` `await` å¾ˆç®€å•ï¼Œä½†è¿˜æ˜¯éœ€è¦å¤„ç†é”™è¯¯ã€‚
```javascript
async function getJSON(url) {
  try {
    let res = await fetch(url);
    return await res.json();
  } catch (err) {
    console.log(err);
  }
}
```

## çŸ¥é“æ›´å¥½
`$.ajax()` è¿”å›ä¸€ä¸ª `thenable` å¯¹è±¡(å°±æ˜¯æœ‰ `then()` æ–¹æ³•çš„å¯¹è±¡)ï¼Œå¯ä»¥è¢«å½“æˆä¸€ä¸ª Promiseã€‚

`then(onresolve, onreject)` `catch(onreject)` çš„ä¸­ `onresolve` å’ŒÂ `onreject` æ€»æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚

```javascript
let promise = new Promise((resolve, reject) => resolve('ğŸš•'));

promise.then(console.log);

console.log('ğŸš€'); Â  Â  Â  // ğŸš€ å…ˆè¢«æ‰“å°å‡ºæ¥
```

`unhandledrejection` äº‹ä»¶
```javascript
window.addEventListener('unhandledrejection', function (event) {
  console.warn(event.reason);
});
```

## è§†é¢‘æ•™ç¨‹
* https://www.youtube.com/watch?v=vQ3MoXnKfuQ

## å‚è€ƒæ¡ˆä¾‹
* https://twhy.github.io/github-user-finder [æºç ](https://github.com/twhy/github-user-finder)

## å¼€æºé¡¹ç›®
* [axios](https://github.com/mzabriskie/axios) Promise based HTTP client for the browser and node.js

## å‚è€ƒé“¾æ¥
* [Promise A+ è§„èŒƒ](https://promisesaplus.com)
* http://callbackhell.com
* https://davidwalsh.name/promises
* https://github.com/mzabriskie/axios
* http://javascript.info/promise-basics
* http://javascript.info/promise-api
* http://javascript.info/promise-chaining
* http://javascript.info/async-await
* https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all
* https://developers.google.com/web/fundamentals/getting-started/primers/promises
* https://developer.mozilla.org/en-US/docs/Web/Events/unhandledrejection
* https://stackoverflow.com/questions/32721850/why-the-response-object-from-javascript-fetch-api-is-a-promise

# äº‹ä»¶ Event

ç½‘é¡µä¸­å¸¸è§çš„äº‹ä»¶æœ‰ç”¨æˆ·ç‚¹å‡»ï¼Œè¡¨å•æäº¤ç­‰ï¼ŒåŒæ—¶ä½ è¿˜å¯ä»¥è‡ªå®šä¹‰äº‹ä»¶å¦‚æ–°å»ºè®¢å•ï¼Œæ‘‡ä¸€æ‘‡ã€‚äº‹ä»¶çš„æ¦‚å¿µå¹¶ä¸é™äº JavaScriptï¼Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€éƒ½æœ‰äº‹ä»¶æ¨¡å‹ã€‚

## å¸¸è§äº‹ä»¶
| äº‹ä»¶                                               | è§£é‡Š                |
|---------------------------------------------------|---------------------|
| `click` `dblclick`                                | é¼ æ ‡ ğŸ–± å•å‡»/åŒå‡»     |
| `mouseenter` `mousemove` `mouseleave`             | é¼ æ ‡ ğŸ–± è¿›å…¥/ç§»åŠ¨/ç¦»å¼€ |
| `submit` `reset`                                  | è¡¨å•æäº¤/é‡ç½®         |
| `keydown` `keyup`                                 | é”®ç›˜é”®æŒ‰ä¸‹/æ¾å¼€       |
| `touchstart` `touchmove` `touchend` `touchcancel` | è§¦æ§äº‹ä»¶             |
| `transitionstart` `transitionrun` `transitionend` | CSS è¿‡æ¸¡åŠ¨ç”»äº‹ä»¶      |
| `DOMContentLoaded` Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   | DOM æ ‘ ğŸŒ² æ„å»ºå®Œæˆäº‹ä»¶ |
| `load` Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   | ç½‘é¡µå›¾ç‰‡ç­‰åŠ è½½å®Œæˆäº‹ä»¶  |

ğŸ’¡ è¿˜æœ‰å¾ˆå¤šå…¶ä»– DOM äº‹ä»¶å’Œé DOMÂ äº‹ä»¶ï¼Œè¯·å‚é˜… [MDN äº‹ä»¶åˆ—è¡¨](https://developer.mozilla.org/en-US/docs/Web/Events)ã€‚

## å“åº”äº‹ä»¶
### HTML å±æ€§
é€šè¿‡å…ƒç´ çš„ `on<event>`(å¦‚ `onclick`)å±æ€§å“åº”äº‹ä»¶ã€‚
```html
<button onclick="alert('æ¸…é™¤æˆåŠŸ!')">æ¸…é™¤ç¼“å­˜</button>
```
```html
<script>
  function clearCache() { alert('æ¸…é™¤æˆåŠŸ!'); }
</script>

<button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
```
### DOM å±æ€§
```javascript
window.onload = function() {
 Â console.log('æ‰€æœ‰å¤–éƒ¨èµ„æºåŠ è½½å®Œæˆï¼Œå‡†å¤‡å‘å°„ ğŸš€');
};
```
ç§»é™¤é€šè¿‡ DOM å±æ€§æ·»åŠ çš„äº‹ä»¶ç›‘å¬å‡½æ•°ã€‚
```javascript
window.onload = null;
```
ğŸ’¡ ä»¥ä¸Šä¸¤ç§å“åº”äº‹ä»¶çš„æ–¹å¼ä»…é€‚åˆç®€å•é¡µé¢ï¼Œå› ä¸º `on<event>` å±æ€§å¦‚ `onclick` ä»…æœ‰ä¸€ä¸ªã€‚

### æ ‡å‡†æ–¹æ³•
#### addEventListener
`EventTarget.prototype.addEventListener()` æ˜¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨çš„æ ‡å‡†æ–¹æ³•ï¼Œå¯ç»™åŒä¸€äº‹ä»¶æ·»åŠ å¤šä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚
```javascript
// ä½¿ç”¨åŒ¿åå‡½æ•°ä½œä¸ºäº‹ä»¶ç›‘å¬å™¨
window.addEventListener('resize', function() {
  console.log('window.innerWidth', window.innerWidth, 'window.innerHeight', window.innerHeight);
});

function logDocumentClientSize() {
  let width = document.documentElement.clientWidth;
  let height = document.documentElement.clientHeight;
  console.log('documentElement.clientWidth', width, 'documentElement.clientHeight', height);
}

// ä½¿ç”¨å…·åå‡½æ•°ä½œä¸ºäº‹ä»¶ç›‘å¬å™¨
window.addEventListener('resize', logDocumentClientSize);
```

#### removeEventListener
`EventTarget.prototype.removeEventListener()` æ–¹æ³•ç”¨äºç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚
```javascript
// ç§»é™¤äº‹ä»¶ç›‘å¬å™¨å¿…é¡»ç»™å®šå‡½æ•°å
window.removeEventListener('resize', logDocumentClientSize);
```
âš ï¸ ä»¥ä¸‹ä»£ç **ä¸èƒ½**è¾¾åˆ°ç§»é™¤äº‹ä»¶ç›‘å¬å™¨çš„ç›®çš„ã€‚
```javascript
window.removeEventListener('resize', function() {
  console.log('window.innerWidth', window.innerWidth, 'window.innerHeight', window.innerHeight);
});
```
#### å¯¹è±¡ä½œä¸ºäº‹ä»¶ç›‘å¬å™¨
é™¤äº†å¯ä»¥ç»™ `addEventListener` ä¼ é€’ä¸€ä¸ªå‡½æ•°ä½œä¸ºäº‹ä»¶ç›‘å¬å™¨ï¼Œè¿˜å¯ä»¥ä¼ é€’ä¸€ä¸ªåŒ…å« `handleEvent` æ–¹æ³•çš„å¯¹è±¡ã€‚  
ä»¥è¿™ç§æ–¹å¼æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ—¶ï¼Œç›‘å¬å™¨æ˜¯ä»¥ `handler.handleEvent(event)` æ–¹å¼è°ƒç”¨ï¼Œå› æ­¤ `this` æ˜¯ `handler`ã€‚
```javascript
var handler = {
  handleEvent(event) {
 Â  Â switch (event.type) {
      case 'mousedown':
 Â  Â  Â  Â console.log('é¼ æ ‡æŒ‰ä¸‹', event.clientX, event.clientY);
        break;
      case 'mousemove':
 Â  Â  Â  Â console.log('é¼ æ ‡ç§»åŠ¨', event.clientX, event.clientY);
        break;
    }
  }
};

document.addEventListener('mousedown', handler);
document.addEventListener('mousemove', handler);
```
åŒæ ·æ˜¯é€šè¿‡ `removeEventListener` ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚
```javascript
document.removeEventListener('mousedown', handler);
document.removeEventListener('mousemove', handler);
```
å¯¹è±¡ä½œä¸ºäº‹ä»¶ç›‘å¬å™¨çš„å¸¸ç”¨åœºæ™¯æ˜¯å’Œç±» `class` ç»“åˆä½¿ç”¨ã€‚
```javascript
class TouchPad {
  constructor() {
 Â  Â document.addEventListener('touchstart', this);
    document.addEventListener('touchmove', this);
    document.addEventListener('touchend', this);
 Â }
  
  handleEvent(event) {
 Â  Â if (event.type === 'touchstart') return this.onTouchStart(event);
    if (event.type === 'touchmove') return this.onTouchMove(event);
    if (event.type === 'touchend') return this.onTouchEnd(event);
 Â }
  
 Â onTouchStart(event) { console.log('è§¦æ§å¼€å§‹', event.touches[0].clientX, event.touches[0].clientY); }
  
 Â onTouchMove(event) { console.log('è§¦æ§ç§»åŠ¨', event.touches[0].clientX, event.touches[0].clientY); }
  
 Â onTouchEnd(event) { console.log('è§¦æ§ç»“æŸ', event); }
}
```

## äº‹ä»¶å¯¹è±¡
å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæµè§ˆå™¨ä¼šæ–°å»ºä¸€ä¸ªäº‹ä»¶å¯¹è±¡(åŒ…å«è¯¥äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯)ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™äº‹ä»¶ç›‘å¬å™¨å‡½æ•°ã€‚
```javascript
document.addEventListener('click', function(event) {
 Â console.log('äº‹ä»¶å¯¹è±¡', event);
 Â console.log('äº‹ä»¶ç±»å‹', event.type);
 Â console.log('è§¦å‘äº‹ä»¶çš„å…ƒç´ ', event.target);
 Â console.log('ç›‘å¬äº‹ä»¶çš„å…ƒç´ ', event.currentTarget);
 Â console.log('äº‹ä»¶å‘ç”Ÿçš„åæ ‡', event.clientX, event.clientY, '(ä»¥çª—å£å·¦ä¸Šè§’ä¸ºåŸç‚¹)');
  
  console.log('this', this);
  console.log('this === event.currentTarget', this === event.currentTarget);    // true
});
```
ğŸ’¡ äº‹ä»¶å¯¹è±¡çš„åå­—è‡ªå®šï¼Œå¸¸è§çš„æœ‰ `e` `evt` `event`ã€‚

ğŸ¤” `event.target` å’Œ `event.currentTarget` çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

## äº‹ä»¶ä¼ æ’­ Event Propagation
æ ‡å‡† [DOM äº‹ä»¶](https://www.w3.org/TR/DOM-Level-3-Events/) çš„ä¼ æ’­åˆ†æˆä¸‰ä¸ªé˜¶æ®µã€‚
1. æ•è·é˜¶æ®µ - äº‹ä»¶å¾€ä¸‹ä¼ æ’­è‡³å…ƒç´  (ä¸ºä»€ä¹ˆä¸æ˜¯æ½œæ°´é˜¶æ®µï¼Ÿæ½œæ°´å’Œå†’æ³¡æ‰æ˜¯ä¸€å¯¹ ğŸ¤”)
2. ç›®æ ‡é˜¶æ®µ - äº‹ä»¶æŠµè¾¾ç›®æ ‡å…ƒç´ 
3. å†’æ³¡é˜¶æ®µ - äº‹ä»¶ä»å…ƒç´ å‘ä¸Šä¼ æ’­

`event.eventPhase` å±æ€§è¡¨æ˜äº‹ä»¶æ‰€å¤„çš„ä¼ æ’­é˜¶æ®µï¼Œ`1` æ˜¯æ•è·é˜¶æ®µï¼Œ`3` æ˜¯å†’æ³¡é˜¶æ®µã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œäº‹ä»¶çš„ä¼ æ’­å‘ˆ `V` å­—å‹ã€‚ ğŸŒ° æ½œæ°´ä¸å†’æ³¡ä¹‹å¥—å¨ƒ https://twhy.github.io/capture-and-bubble

### æ•è· Capture
`0.01% ä½¿ç”¨ç‡` `eventTarget.addEventListener('click', listener, true)`

æ•è·æ˜¯æŒ‡äº‹ä»¶å¾€ä¸‹ä¼ æ’­åˆ°å…ƒç´ çš„è¿‡ç¨‹ï¼Œå¯ä»¥æ·»åŠ æ•è·é˜¶æ®µçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œè™½ç„¶å¹¶ä¸å¸¸ç”¨ã€‚

### å†’æ³¡ Bubble
`99.9% ä½¿ç”¨ç‡` `eventTarget.addEventListener('click', listener, false) Â   // false å¯çœç•¥`

å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿåœ¨å…ƒç´ ä¸Šæ—¶ï¼Œé¦–å…ˆæ‰§è¡Œå…ƒç´ ä¸Šç›¸åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œæ¥ç€æ‰§è¡Œå…¶çˆ¶å…ƒç´ ä¸Šçš„ï¼Œç„¶åæ‰§è¡Œå…¶ä»–ç¥–å…ˆå…ƒç´ ä¸Šçš„ã€‚

ğŸ’¡ å¤§éƒ¨åˆ†äº‹ä»¶éƒ½ä¼šå†’æ³¡ï¼Œä½†æœ‰äº›äº‹ä»¶ä¾‹å¤–ï¼Œå¦‚ `focus`ã€‚

### ç»ˆæ­¢ä¼ æ’­
`event.stopPropagation()` æ–¹æ³•ç”¨äºç»ˆæ­¢äº‹ä»¶ä¼ æ’­ã€‚åŒä¸€äº‹ä»¶çš„å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ä»ç„¶ä¼šè¢«è°ƒç”¨ã€‚

`event.stopImmediatePropagation()` æ–¹æ³•ç”¨äºç»ˆæ­¢äº‹ä»¶ä¼ æ’­ï¼ŒåŒæ—¶é˜»æ­¢åŒä¸€äº‹ä»¶çš„å…¶ä»–ç›‘å¬å™¨è¢«è°ƒç”¨ã€‚

ğŸ’¡ å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½**ä¸éœ€è¦**ä¹Ÿ**æ²¡å¿…è¦**ç»ˆæ­¢äº‹ä»¶ä¼ æ’­ã€‚

## äº‹ä»¶å§”æ‰˜ Event Delegation
äº‹ä»¶å§”æ‰˜æ˜¯åŸºäºå†’æ³¡çš„äº‹ä»¶å¤„ç†æ¨¡å¼ã€‚å®ƒçš„åŸºæœ¬åŸç†æ˜¯ï¼š

> åœ¨å¤šä¸ªéœ€è¦æ·»åŠ äº‹ä»¶ç›‘å¬å™¨çš„å­å…ƒç´ çš„æŸä¸ªç¥–å…ˆå…ƒç´ (å¦‚ `document`)ä¸Šæ·»åŠ ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œç„¶åé€šè¿‡ `event.target` åˆ¤æ–­æ˜¯å“ªä¸ªå­å…ƒç´ è§¦å‘äº‹ä»¶ï¼Œå¹¶è¿›è¡Œç›¸åº”å¤„ç†ï¼Œä»è€Œé¿å…åœ¨æ¯ä¸ªå­å…ƒç´ ä¸Šå•ç‹¬æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ã€‚

ğŸŒ° ç‚¹å‡» `.category` æˆ– `span` åç»™ `.category` è®¾ç½® `data-color` æŒ‡å®šçš„èƒŒæ™¯è‰²ã€‚
```html
<div class="categories">
  <div class="category sports" data-color="limegreen">
    <span>âš½ï¸</span><span>ğŸ€</span><span>ğŸ¾</span>
  </div>
  <div class="category animals" data-color="darkorange">
    <span>ğŸ¶</span><span>ğŸ¼</span><span>ğŸ¯</span>
  </div>
  <div class="category places" data-color="deepskyblue">
    <span>ğŸ¯</span><span>ğŸ›</span><span>ğŸŸ</span>
  </div>
</div>
```
```javascript
document.addEventListener('click', function(event) {
  let target = event.target;
  if (target.nodeName === 'SPAN') {
    target.parentElement.style.background = target.parentElement.dataset.color;
  }
  if (target.matches('.category')) {
    target.style.background = target.dataset.color;
  }
});
```
ğŸš€ https://codepen.io/twhy/pen/xLbgza

ğŸŒ° ç»“åˆå§”æ‰˜å’Œ `data-*` å±æ€§ç»™å…ƒç´ æ·»åŠ è¡Œä¸ºã€‚
```html
<input type="button" value="1" data-steper>
<input type="button" value="5" data-steper data-step="5">

<script>
  document.addEventListener('click', function(event) {
    let target = event.target;
    if (target.hasAttribute('data-steper')) {
      target.value = +target.value + (+target.dataset.step || 1);
    }
  });
</script>
```

## é»˜è®¤è¡Œä¸º Default Action
å¾ˆå¤šäº‹ä»¶ä¼šå¼•å‘æµè§ˆå™¨çš„é»˜è®¤è¡Œä¸ºï¼Œå¸¸è§çš„æœ‰ï¼š
* ç‚¹å‡»é“¾æ¥ï¼Œé¡µé¢è·³è½¬
* ç‚¹å‡»è¡¨å•å†…çš„æäº¤æŒ‰é’®ï¼Œè¡¨å•è¢«æäº¤åˆ°æœåŠ¡ç«¯
* ...

`event.preventDefault()` æ–¹æ³•ç”¨äºé˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºã€‚

`event.defaultPrevented` å±æ€§çš„å€¼ä¸º `true` è‹¥ `event.preventDefault()` è¢«è°ƒç”¨ï¼Œå¦åˆ™ä¸º `false`ã€‚

## äº‹ä»¶åˆ†æ´¾ Event Dispatch
æˆ‘ä»¬å¯ä»¥æ„é€ å’Œåˆ†æ´¾**è‡ªå®šä¹‰äº‹ä»¶**å’Œæµè§ˆå™¨åŸç”Ÿäº‹ä»¶ã€‚

```javascript
document.body.addEventListener('click', function() { console.log('ğŸš€'); });

var event = new Event('click', {
 Â bubbles: true, Â  Â   // æ˜¯å¦å†’æ³¡ï¼Œé»˜è®¤ false
 Â cancelable: true Â   // å¯å¦å–æ¶ˆï¼Œé»˜è®¤ false
});
```
```javascript
> event.isTrusted Â   // è„šæœ¬ç”Ÿæˆçš„äº‹ä»¶å¯¹è±¡ isTrusted å±æ€§çš„å€¼æ˜¯ false
â†’ false

> document.body.lastElementChild.dispatchEvent(event)
 Â ğŸš€
â†’ true
```

## IE å…¼å®¹
IE9- ä¸æ”¯æŒ `addEventListener` æˆ– `removeEventListener`ï¼Œä½†æä¾›äº† `attachEvent` å’Œ `detachEvent` ä¸¤ä¸ªç±»ä¼¼æ–¹æ³•ã€‚ Â 

ğŸ’¡ è‹¥é¡¹ç›®éœ€è¦å…¼å®¹ IE9-ï¼Œè¯·ç›´æ¥ä½¿ç”¨ jQuery 1.xï¼Œè€Œä¸æ˜¯è‡ªè¡Œç¼–å†™å…¼å®¹æ€§ä»£ç ã€‚

## å‚è€ƒé“¾æ¥
* https://davidwalsh.name/event-delegate
* https://javascript.info/dispatch-events
* https://javascript.info/event-delegation
* https://javascript.info/default-browser-action
* https://javascript.info/bubbling-and-capturing
* https://javascript.info/introduction-browser-events
* https://developer.mozilla.org/en-US/docs/Web/Events
* https://webkit.org/blog/5610/more-responsive-tapping-on-ios
* https://developer.mozilla.org/en-US/docs/Web/API/TouchEvent
* https://developer.mozilla.org/en-US/docs/Web/API/Event/bubbles
* https://developer.mozilla.org/en-US/docs/Web/API/Event/eventPhase
* https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget
* https://developer.mozilla.org/en-US/docs/Web/API/Document/readyState
* https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector
* https://developers.google.com/web/updates/2013/12/300ms-tap-delay-gone-away
* https://developers.google.com/web/updates/2016/06/passive-event-listeners
* https://github.com/WICG/EventListenerOptions
* https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md
* https://developer.mozilla.org/en-US/docs/Web/API/Event/stopPropagation
* https://developer.mozilla.org/en-US/docs/Web/API/Event/defaultPrevented
* https://developer.mozilla.org/en-US/docs/Web/API/Event/stopImmediatePropagation
* https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
* https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/removeEventListener
* https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Building_blocks/Events


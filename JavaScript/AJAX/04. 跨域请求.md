# è·¨åŸŸè¯·æ±‚

å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½éœ€è¦ç”¨åˆ°è·¨åŸŸè¯·æ±‚ï¼Œå°¤å…¶æ˜¯åº”ç”¨çš„æ•°æ®æ¥è‡ªç¬¬ä¸‰æ–¹å¹³å°æ—¶ã€‚

## åŒæºç­–ç•¥ Same-origin Policy
åŒæºç­–ç•¥é™åˆ¶ä»Žä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸Žå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œæ˜¯éš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„å…³é”®å®‰å…¨æœºåˆ¶ã€‚

åŒæºç­–ç•¥ä»…é™äºŽåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ XMLHttpRequest æˆ– Fetch å‘èµ·çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¸å­˜åœ¨è¿™ç§é™åˆ¶ã€‚

### æºçš„å®šä¹‰
ä¸¤ä¸ªé¡µé¢åŒæºéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶
* åŒåè®®(Protocol)
* åŒä¸»æœº(Host)
* åŒç«¯å£(Port)

|         URL A Â  Â  Â   |               URL B Â  Â  Â  Â  Â  Â  Â  Â  Â  | æ˜¯å¦åŒæº     |
|:--------------------:|---------------------------------------|:------------|
| `https://github.com` | `https://github.com/fe13`             | æ˜¯Â          |
| `https://github.com` | `http://github.com` Â  Â  Â  Â  Â  Â  Â  Â    | å¦ï¼Œåè®®ä¸åŒ  |
| `https://github.com` | `https://www.github.com/fe13`         | å¦ï¼Œä¸»æœºä¸åŒ  |
| `https://github.com` | `https://api.github.com/users/github` | å¦ï¼Œä¸»æœºä¸åŒ  |
| `https://github.com` | `https://github.com:8000` Â  Â  Â  Â  Â  Â  | å¦ï¼Œç«¯å£ä¸åŒ  |

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”±äºŽåŒæºç­–ç•¥çš„å­˜åœ¨ï¼ŒXMLHttpRequest æˆ– Fetch å‘èµ·çš„ HTTP è¯·æ±‚**ä¸èƒ½**è·¨æº(åŸŸ)ã€‚

## è·¨åŸŸèµ„æºå…±äº« CORS
CORS å…¨ç§° Cross-Origin Resource Sharingï¼Œå®ƒå…è®¸ Web æœåŠ¡å™¨æŽ§åˆ¶è·¨åŸŸè®¿é—®ï¼Œä»Žè€Œå®žçŽ°å®‰å…¨çš„è·¨åŸŸæ•°æ®ä¼ è¾“ã€‚

### æ¦‚è§ˆ
CORS é€šè¿‡å…è®¸æœåŠ¡å™¨æ·»åŠ  HTTP å¤´éƒ¨å­—æ®µ(HTTP Headers) ä»¥æŒ‡å®šæºé›†(ç½‘ç«™é›†åˆ)å¯ä»¥è®¿é—®å“ªäº›ç‰¹å®šèµ„æºçš„æ–¹å¼å·¥ä½œã€‚

å¯¹äºŽä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„è¯·æ±‚(`GET`ï¼ŒæŸäº›ç‰¹å®š MIME ç±»åž‹çš„ `POST` **ä»¥å¤–**çš„è¯·æ±‚)ï¼Œ  
* CORS è¦æ±‚æµè§ˆå™¨é¡»å…ˆä»¥ `OPTIONS` æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚(Preflight Request)ï¼Œä»¥èŽ·çŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ã€‚
* å½“å¾—åˆ°æœåŠ¡å™¨â€œå…è®¸â€åŽï¼Œæ‰å‘èµ·å®žé™…çš„ HTTP è¯·æ±‚ã€‚
* æœåŠ¡å™¨ä¹Ÿå¯ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯åœ¨è¯·æ±‚æ—¶æ˜¯å¦éœ€è¦æºå¸¦å‡­è¯ä¿¡æ¯ï¼ˆåŒ…æ‹¬ Cookies å’Œ HTTP è®¤è¯æ•°æ®ï¼‰ã€‚

### ç®€å•è¯·æ±‚
ç®€å•è¯·æ±‚ä¸ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ã€‚ç®€å•è¯·æ±‚éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
1. è¯·æ±‚æ–¹æ³•æ˜¯ `GET` / `HEAD` / `POST`
2. `Content-Type` æ˜¯ `application/x-www-form-urlencoded` / `multipart/form-data` / `text/plain`
3. æ›´å¤šå‚è§ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)

åœ¨æœ¬é¡µé¢æ‰“å¼€ Chrome Consoleï¼Œå‘ `api.github.com` å‘èµ·è·¨åŸŸè¯·æ±‚ã€‚
```javascript
> fetch('https://api.github.com/users/fe13')
```
```
æµè§ˆå™¨ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   æœåŠ¡å™¨
  |----------------------------------------------->|
 Â | GET /users/fe13 HTTP/1.1 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
  | Host: api.github.com                           |
  | Origin: https://github.com                     |
  |<-----------------------------------------------|
  |                                HTTP/1.1 200 OK |
  |                 Access-Control-Allow-Origin: * |
```
`Access-Control-Allow-Origin: *` è¡¨ç¤ºæœåŠ¡å™¨æŽ¥å—æ¥è‡ªä»»æ„ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ã€‚

æœåŠ¡å™¨å¯ä»¥åªå…è®¸æ¥è‡ªæŸä¸ªæº(å¦‚ `https://fe13.cn`)çš„è·¨åŸŸè¯·æ±‚ã€‚
```
Access-Control-Allow-Origin: https://fe13.cn
```
`Access-Control-Allow-Origin` åº”å½“ä¸º * æˆ–è€…åŒ…å«è¯·æ±‚çš„ `Origin` å¤´éƒ¨å­—æ®µçš„å€¼ã€‚

### é¢„æ£€è¯·æ±‚
ç®€å•è¯·æ±‚ä»¥å¤–çš„è¯·æ±‚ä¼šè§¦å‘é¢„æ£€ã€‚ä»¥ä¸‹**ä»»æ„ä¸€ç§**æƒ…å†µéƒ½ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ã€‚
1. è¯·æ±‚æ–¹æ³•æ˜¯ `PUT` / `DELETE` / `CONNECT` / `OPTIONS` / `TRACE` / `PATCH`
2. `Content-Type` ä¸æ˜¯Â `application/x-www-form-urlencoded` / `multipart/form-data` / `text/plain`
3. æ›´å¤šå‚è§ [MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS#Preflighted_requests)

## JSONP
JSONP ç®€å•æ¥è¯´å°±æ˜¯ä»¥åŠ è½½è„šæœ¬çš„æ–¹å¼èŽ·å– JSON æ•°æ®ã€‚ðŸ’¡ JSONP éœ€è¦æœåŠ¡ç«¯æä¾›æ”¯æŒã€‚

```javascript
function jsonpCallback(data) {
  console.log(data);
}

let script = document.createElement('script')
script.src = `https://octocats.now.sh/jsonp/octocats?callback=jsonpCallback&_=${Date.now()}`
document.body.appendChild(script);
```

### JSONP ä¸Ž jQuery
å°† `$.ajax()` çš„ `dataType` è®¾ç½®æˆ `jsonp` å‘èµ· JSONP è¯·æ±‚(è™½ç„¶ JSONP æœ¬è´¨ä¸Šä¸æ˜¯ AJAX)ã€‚
```javascript
$.ajax({
  url: 'https://octocats.now.sh/jsonp/octocats',
 Â dataType: 'jsonp',
  data: { page: 3 },
  success: function(cats) {
    console.log(cats);
  }
})
```
å¦‚æžœä¸éœ€è¦å…¼å®¹æ—§å¼ IEï¼Œå»ºè®®ä½¿ç”¨ CORS è€Œä¸æ˜¯ JSONPã€‚

## PostMessage

## å‚è€ƒé“¾æŽ¥
* https://isudox.com/2016/09/24/cross-site-jsonp-and-cors
* https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
* https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy
* https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
* https://developer.mozilla.org/en-US/docs/Web/HTTP/Server-Side_Access_Control
* https://stackoverflow.com/questions/2067472/what-is-jsonp-all-about
* https://stackoverflow.com/questions/25309318/best-method-access-control-allow-origin-multiple-origin-domains


# ä½œç”¨åŸŸ Scope

JavaScript æœ‰ä¸‰ç§ä½œç”¨åŸŸï¼šå…¨å±€ä½œç”¨åŸŸï¼Œå‡½æ•°ä½œç”¨åŸŸå’Œå—çº§ä½œç”¨åŸŸï¼Œå…¶ä¸­å—çº§ä½œç”¨åŸŸæ˜¯ `ES6` æ–°å¼•å…¥çš„ç‰¹æ€§ã€‚

## å…¨å±€ä½œç”¨åŸŸ Global Scope
ç¼–ç¨‹ç¯å¢ƒçš„ä¸­å…¨å±€ä½œç”¨åŸŸæ˜¯æŒ‡**åŒ…å«**ä¸”å¯¹å…¶ä»–ä»»ä½•ä½œç”¨åŸŸå¯è§çš„ä½œç”¨åŸŸã€‚

å®¢æˆ·ç«¯ JavaScript ä¸­çš„å…¨å±€ä½œç”¨åŸŸé€šå¸¸æŒ‡æ‰€æœ‰ä»£ç éƒ½è¿è¡Œå…¶ä¸­çš„ç½‘é¡µï¼Œå®šä¹‰åœ¨å…¨å±€ä½œç”¨åŸŸçš„å€¼å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¢«è®¿é—®ã€‚

```javascript
var lyrics = 'å“Ÿå“Ÿï¼';  // å…¨å±€å˜é‡

function qkn() {
 Â lyrics += 'åˆ‡';
 Â return kn();
  
  function kn() {
 Â  Â lyrics += 'å…‹';
    return nao();
    
    function nao() {
 Â  Â  Â lyrics += 'é—¹ï¼';
      return lyrics;
    }
  }
}
```
```javascript
> qkn()
â†’ å“Ÿå“Ÿï¼åˆ‡å…‹é—¹ï¼
```

## å‡½æ•°ä½œç”¨åŸŸ Function Scope
æ¯ä¸ªå‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸï¼Œåœ¨å…¶ä¸­å®šä¹‰çš„å€¼ä»…åœ¨è¯¥ä½œç”¨åŸŸå¯è§ã€‚

å‡½æ•°ä¸­ä½¿ç”¨ `var` å£°æ˜çš„å˜é‡åœ¨æ•´ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…å¯è§ã€‚
```javascript
var lyrics = 'å“Ÿå“Ÿï¼åˆ‡å…‹é—¹ï¼';  // å…¨å±€å˜é‡

function xq() {
 Â var lyrics = '';
  
  hands();
  steps();
  watch();
  
  return lyrics;
  
  function hands() { lyrics += 'æ‰‹ç‰µæ‰‹ '; }
  function steps() { lyrics += 'ä¸€æ­¥ä¸¤æ­¥ä¸‰æ­¥å››æ­¥ '; }
  function watch() { lyrics += 'æœ›ç€å¤©'; }
}
```
```javascript
> xq()
â†’ "æ‰‹ç‰µæ‰‹ ä¸€æ­¥ä¸¤æ­¥ä¸‰æ­¥å››æ­¥ æœ›ç€å¤©"

> lyrics
â†’ "å“Ÿå“Ÿï¼åˆ‡å…‹é—¹ï¼"
```

`var` å£°æ˜çš„å˜é‡æœ€å°å¯è§èŒƒå›´æ˜¯å‡½æ•°ä½œç”¨åŸŸã€‚
```javascript
(function() {

  if (navigator.language === 'zh-CN') {
 Â  Â var city = 'å¦é—¨';
 Â  Â console.log(`${city}å¾ˆä¸é”™`);
 Â } else {
    var city = 'Amoy';
    console.log(`${city} is good`);
  }
  
 Â console.log(city);  // city åœ¨æ•´ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…å¯è§
})();
```

## å—çº§ä½œç”¨åŸŸ Block Scope
`ES6` ä¸º JavaScript æ–°å¢äº†å—çº§ä½œç”¨åŸŸã€‚`let` å’Œ `const` å£°æ˜çš„å˜é‡å…·æœ‰å—çº§ä½œç”¨åŸŸã€‚
```javascript
for (let i = 1; i <= 10; i++) {
  console.log(i);
}
```
ç”±äº `i` ä½¿ç”¨ `let` å£°æ˜ï¼Œå› æ­¤ä»…åœ¨ `for` å¾ªç¯å†…å¯è§ï¼Œåœ¨å…¨å±€ä¸å¯è§ã€‚
```javascript
> i
Ã— Uncaught ReferenceError: i is not defined
``` 

`ES6` ä¹‹å‰æ²¡æœ‰å—çº§ä½œç”¨åŸŸï¼Œæ²¡æœ‰ `let` æˆ– `const`ï¼Œåªæœ‰å…¨å±€ä½œç”¨åŸŸå’Œå‡½æ•°ä½œç”¨åŸŸä»¥åŠ `var`ã€‚

ğŸ¤” ä¸ºä»€ä¹ˆä»¥ä¸‹ç¨‹åºä¸èƒ½æ­£ç¡®è¿è¡Œï¼Ÿ
```javascript
(function() {
 Â // æŒ‰ç…§ tasks çš„é¡ºåºå’Œç­‰å¾…æ—¶é—´ wait æ‰§è¡Œä»»åŠ¡
 Â var tasks = [
 Â  Â { name: 'å‡ºåœº ğŸ˜€', wait: 2 },
 Â  Â { name: 'éšèº« ğŸ¤¡', wait: 3 },
 Â  Â { name: 'æ”¾å¤§ ğŸ˜', wait: 5 }
  ];
  
  for (var i = 0; i < tasks.length; i++) {
    setTimeout(function() {
 Â  Â  Â console.log('æ‰§è¡Œä»»åŠ¡ ' + tasks[i].name);  // ç¨‹åºæŠ¥é”™ Cannot read property 'name' of undefined
    }, tasks[i].wait * 1000);
  }
  
 Â console.log(i);  // i åœ¨æ•´ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…å¯è§
})();
```
ğŸ’¡ å£°æ˜ä¸€ä¸ªå‡½æ•°(æ–°å»ºå‡½æ•°ä½œç”¨åŸŸ)è§£å†³é—®é¢˜ã€‚
```javascript
(function() {
 Â // æŒ‰ç…§ tasks çš„é¡ºåºå’Œç­‰å¾…æ—¶é—´ wait æ‰§è¡Œä»»åŠ¡
 Â var tasks = [
 Â  Â { name: 'å‡ºåœº ğŸ˜€', wait: 2 },
 Â  Â { name: 'éšèº« ğŸ¤¡', wait: 3 },
 Â  Â { name: 'æ”¾å¤§ ğŸ˜', wait: 5 }
  ];
  
  var run = function(index) {
    setTimeout(function() {
 Â  Â  Â console.log('æ‰§è¡Œä»»åŠ¡ ' + tasks[index].name);
    }, tasks[index].wait * 1000);
  };
  
  for (var i = 0; i < tasks.length; i++) {
    run(i);
  }
    
 Â console.log(i);  // i åœ¨æ•´ä¸ªå‡½æ•°ä½œç”¨åŸŸå†…å¯è§
})();
```
ğŸ’¡ ä½¿ç”¨ `let` è§£å†³é—®é¢˜ã€‚é€šè¿‡ https://babeljs.io/repl æŸ¥çœ‹ç¼–è¯‘æˆ `ES3` çš„ä»£ç ã€‚
```javascript
(function() {
 Â // æŒ‰ç…§ tasks çš„é¡ºåºå’Œç­‰å¾…æ—¶é—´ wait æ‰§è¡Œä»»åŠ¡
 Â var tasks = [
 Â  Â { name: 'å‡ºåœº ğŸ˜€', wait: 2 },
 Â  Â { name: 'éšèº« ğŸ¤¡', wait: 3 },
 Â  Â { name: 'æ”¾å¤§ ğŸ˜', wait: 5 }
  ];
  
  for (let i = 0; i < tasks.length; i++) {
    setTimeout(function() {
      console.log('æ‰§è¡Œä»»åŠ¡ ' + tasks[i].name);
    }, tasks[i].wait * 1000);
  }
  
 Â // console.log(i) ä¼šæŠ¥é”™ï¼Œå› ä¸º i ä»…åœ¨ for å¾ªç¯å†…å¯è§
})();
```
ğŸ’¡ ä½¿ç”¨ `Array.prototype.forEach()` éå†ä»»åŠ¡ã€‚
```javascript
[ { name: 'å‡ºåœº ğŸ˜€', wait: 2 },
  { name: 'éšèº« ğŸ¤¡', wait: 3 },
  { name: 'æ”¾å¤§ ğŸ˜', wait: 5 }
].forEach(function(task) {
  setTimeout(function() {
    console.log('æ‰§è¡Œä»»åŠ¡ ' + task.name);
  }, task.wait * 1000);
});
```

### `{}` æ›¿ä»£Â IIFE
âš ï¸ ä»¥ä¸‹ä»£ç ä»…ä½œæ¼”ç¤ºç”¨é€”ï¼Œä¸ºä¿è¯ä»£ç çš„å¯è¿è¡Œæ€§ï¼Œè¯·ä½¿ç”¨ IIFEã€‚
```javascript
{
  let keyframes = [
    { transform: 'translateY(-180px)' }, 
    { transform: 'translateY(0)' }
  ];
  let options = {
    duration: 600,
    easing: 'cubic-bezier(0.565,1.65,0.765,0.88)',
  };
  
  document.body.animate(keyframes, options);
}
```

## æœ¬èŠ‚è¦ç‚¹
* ä½¿ç”¨Â `var` å£°æ˜çš„å˜é‡æœ€å°å¯è§èŒƒå›´æ˜¯**å‡½æ•°ä½œç”¨åŸŸ**ã€‚
* ä½¿ç”¨ `let` `const` å£°æ˜çš„å˜é‡/å¸¸é‡æœ€å°å¯è§èŒƒå›´æ˜¯**å—çº§ä½œç”¨åŸŸ**ã€‚

## æœ¬èŠ‚ç»ƒä¹ 
* ä»¥ä¸‹ä¸¤ä¸ª `console.log(flower)` åˆ†åˆ«è¾“å‡ºä»€ä¹ˆï¼Ÿ
```javascript
var flower = 'ğŸŒ¸';

(function() {
 Â if ('ğŸ’˜') {
 Â  Â let flower = 'ğŸŒ¹';
 Â  Â console.log(flower);
  }
  
  console.log(flower);
})();
```

* å°ç™½åŒå­¦å†™äº†ä»¥ä¸‹å‡½æ•°ç”¨äºè¾“å‡ºæ•°å­—ä» 1 åˆ° n (æ¯éš”ä¸€ç§’è¾“å‡ºä¸€ä¸ª)ï¼Œä½†å®é™…æ‰§è¡Œç»“æœä¸é¢„æœŸä¸ç¬¦ï¼Œè¯·å¸®åŠ©ä»–ä¿®æ­£ç¨‹åºã€‚
```javascript
function countTo(n) {
 Â for (var i = 1; i <= n; i++) {
    setTimeout(function() {
      console.log(i);
    }, (i - 1) * 1000);
  }
}

countTo(5);
```

## å‚è€ƒé“¾æ¥
* https://javascript.info/var
* https://stackoverflow.com/questions/16473350/let-keyword-in-the-for-loop
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Grammar_and_types#Variable_scope
* http://www.ecma-international.org/ecma-262/6.0/#sec-for-statement-runtime-semantics-labelledevaluation
